<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Dashboard de Marcadores</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fa; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .bookmarks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .category { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
    .category-header { padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; }
    .bookmark-list { padding: 15px; }
    .bookmark { display: flex; align-items: center; padding: 10px; text-decoration: none; color: #2c3e50; }
    .bookmark-icon { margin-right: 10px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 15% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 8px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; }
    .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    .btn { padding: 10px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
    .btn:hover { background: #2980b9; }
    .category-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
    .category-actions button { margin-left: 5px; padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mi Dashboard de Marcadores</h1>
    <button class="btn" onclick="openCategoryManagerModal()">Gestionar Categorías</button>
    <button class="btn" onclick="downloadJson()">Descargar data.json</button>
    <input type="file" id="uploadJson" accept=".json" style="display: none;" onchange="uploadJson(event)">
    <button class="btn" onclick="document.getElementById('uploadJson').click()">Subir y Actualizar data.json</button>
    <div class="bookmarks-grid" id="bookmarksGrid"></div>
  </div>

  <!-- Modal de Gestión de Categorías -->
  <div id="categoryManagerModal" class="modal">
    <div class="modal-content">
      <h2>Gestión de Categorías</h2>
      <form id="newCategoryForm">
        <div class="form-group">
          <label for="newCategoryName">Nombre:</label>
          <input type="text" id="newCategoryName" required>
        </div>
        <div class="form-group">
          <label for="newCategoryColor">Color:</label>
          <input type="color" id="newCategoryColor" value="#3498db">
        </div>
        <button type="submit" class="btn">Añadir Categoría</button>
      </form>
      <div id="categoriesList"></div>
      <button class="btn" onclick="closeCategoryManagerModal()">Cerrar</button>
    </div>
  </div>

  <!-- Modal para Añadir Marcador -->
  <div id="newBookmarkModal" class="modal">
    <div class="modal-content">
      <h2>Añadir Marcador</h2>
      <form id="newBookmarkForm">
        <div class="form-group">
          <label for="bookmarkTitle">Título:</label>
          <input type="text" id="bookmarkTitle" required>
        </div>
        <div class="form-group">
          <label for="bookmarkURL">URL:</label>
          <input type="url" id="bookmarkURL" required>
        </div>
        <div class="form-group">
          <label for="bookmarkIcon">Icono (opcional):</label>
          <input type="text" id="bookmarkIcon" placeholder="SVG o URL">
        </div>
        <button type="submit" class="btn">Añadir Marcador</button>
        <button type="button" class="btn" onclick="closeNewBookmarkModal()">Cancelar</button>
      </form>
    </div>
  </div>

  <script>
    let categories = [];
    let selectedCategoryName = null;

    // Configuración de GitHub
    const GITHUB_TOKEN = "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";
    const REPO_OWNER = "vtedash";
    const REPO_NAME = "vtedash";
    const FILE_PATH = "data.json";

    // Cargar categorías desde GitHub
    async function loadCategoriesFromGitHub() {
      try {
        const response = await fetch(
          `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
          {
            headers: {
              Authorization: `token ${GITHUB_TOKEN}`,
              Accept: "application/vnd.github.v3+json",
            },
          }
        );
        if (!response.ok) throw new Error(`Error al cargar datos: ${response.statusText}`);
        const fileData = await response.json();
        const content = atob(fileData.content);
        categories = JSON.parse(content);
      } catch (error) {
        console.error("Error al cargar categorías:", error);
        categories = [
          {
            id: 1,
            name: "Trabajo",
            color: "#3498db",
            bookmarks: [
              { title: "Gmail Corporativo", url: "https://mail.google.com", icon: "" },
            ],
          },
        ];
      }
    }

    // Guardar categorías en GitHub
    async function saveCategoriesToGitHub() {
      try {
        const fileResponse = await fetch(
          `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
          {
            headers: {
              Authorization: `token ${GITHUB_TOKEN}`,
              Accept: "application/vnd.github.v3+json",
            },
          }
        );
        let sha;
        if (fileResponse.ok) {
          const fileData = await fileResponse.json();
          sha = fileData.sha;
        } else if (fileResponse.status === 404) {
          sha = null; // Archivo no existe, se creará
        } else {
          throw new Error("Error al obtener el SHA del archivo");
        }

        const content = btoa(JSON.stringify(categories, null, 2));
        const commitMessage = "Actualizar data.json";

        const updateResponse = await fetch(
          `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
          {
            method: "PUT",
            headers: {
              Authorization: `token ${GITHUB_TOKEN}`,
              Accept: "application/vnd.github.v3+json",
            },
            body: JSON.stringify({
              message: commitMessage,
              content: content,
              sha: sha,
            }),
          }
        );
        if (!updateResponse.ok) throw new Error("Error al guardar los datos en GitHub");
        console.log("Datos guardados en GitHub");
      } catch (error) {
        console.error("Error al guardar categorías:", error);
        alert("No se pudo guardar los cambios en GitHub. Usa los botones para descargar y subir manualmente.");
      }
    }

    // Descargar el archivo data.json
    function downloadJson() {
      const jsonString = JSON.stringify(categories, null, 2);
      const blob = new Blob([jsonString], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "data.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // Subir y actualizar el archivo data.json
    async function uploadJson(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const newCategories = JSON.parse(text);

        // Actualizar categorías localmente
        categories = newCategories;

        // Guardar en GitHub
        await saveCategoriesToGitHub();

        // Renderizar categorías actualizadas
        renderCategories();
        renderCategoryManagementList();
        alert("Archivo data.json actualizado exitosamente.");
      } catch (error) {
        console.error("Error al subir y actualizar el archivo:", error);
        alert("Error al procesar el archivo JSON. Asegúrate de que sea válido.");
      }
    }

    // Renderizar categorías
    function renderCategories() {
      const grid = document.getElementById("bookmarksGrid");
      grid.innerHTML = "";
      categories.forEach((category) => {
        const categoryDiv = document.createElement("div");
        categoryDiv.className = "category";
        categoryDiv.setAttribute("data-category", category.name);

        const header = document.createElement("div");
        header.className = "category-header";
        header.style.backgroundColor = category.color;
        header.innerHTML = `${category.name} <button onclick="openNewBookmarkModal('${category.name}')">+</button>`;
        categoryDiv.appendChild(header);

        const bookmarkList = document.createElement("div");
        bookmarkList.className = "bookmark-list";
        category.bookmarks.forEach((bookmark) => {
          const a = document.createElement("a");
          a.href = bookmark.url;
          a.className = "bookmark";
          a.target = "_blank";
          let iconContent = bookmark.icon || "🔗";
          a.innerHTML = `${iconContent} ${bookmark.title}`;
          bookmarkList.appendChild(a);
        });

        categoryDiv.appendChild(bookmarkList);
        grid.appendChild(categoryDiv);
      });
    }

    // Funciones para gestionar modales
    function openCategoryManagerModal() {
      renderCategoryManagementList();
      document.getElementById("categoryManagerModal").style.display = "block";
    }

    function closeCategoryManagerModal() {
      document.getElementById("categoryManagerModal").style.display = "none";
    }

    function openNewBookmarkModal(categoryName) {
      selectedCategoryName = categoryName;
      document.getElementById("newBookmarkForm").reset();
      document.getElementById("newBookmarkModal").style.display = "block";
    }

    function closeNewBookmarkModal() {
      document.getElementById("newBookmarkModal").style.display = "none";
    }

    window.onclick = function (event) {
      const categoryModal = document.getElementById("categoryManagerModal");
      const bookmarkModal = document.getElementById("newBookmarkModal");
      if (event.target === categoryModal) closeCategoryManagerModal();
      if (event.target === bookmarkModal) closeNewBookmarkModal();
    };

    // Renderizar lista de categorías en el modal
    function renderCategoryManagementList() {
      const list = document.getElementById("categoriesList");
      list.innerHTML = "";
      categories.forEach((category, index) => {
        const item = document.createElement("div");
        item.className = "category-item";
        item.innerHTML = `
          ${category.name}
          <div class="category-actions">
            <button onclick="editCategory(${index})">Editar</button>
            <button onclick="deleteCategory(${index})">Eliminar</button>
            <button onclick="moveCategoryUp(${index})">↑</button>
            <button onclick="moveCategoryDown(${index})">↓</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    // Añadir nueva categoría
    document.getElementById("newCategoryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("newCategoryName").value.trim();
      const color = document.getElementById("newCategoryColor").value;
      if (!name) return alert("Introduce un nombre para la categoría.");
      if (categories.some((cat) => cat.name.toLowerCase() === name.toLowerCase()))
        return alert("La categoría ya existe.");

      categories.push({ id: Date.now(), name, color, bookmarks: [] });
      await saveCategoriesToGitHub();
      renderCategories();
      renderCategoryManagementList();
      e.target.reset();
    });

    // Añadir nuevo marcador
    document.getElementById("newBookmarkForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!selectedCategoryName) return;
      const title = document.getElementById("bookmarkTitle").value.trim();
      const url = document.getElementById("bookmarkURL").value.trim();
      const icon = document.getElementById("bookmarkIcon").value.trim();
      if (!title || !url) return alert("Completa el título y la URL.");

      const categoryIndex = categories.findIndex((cat) => cat.name === selectedCategoryName);
      if (categoryIndex === -1) return alert("Categoría no encontrada.");
      categories[categoryIndex].bookmarks.push({ title, url, icon });
      await saveCategoriesToGitHub();
      renderCategories();
      closeNewBookmarkModal();
    });

    // Funciones de edición y reordenamiento
    async function editCategory(index) {
      const newName = prompt("Editar nombre:", categories[index].name);
      if (newName && newName.trim()) {
        if (categories.some((cat, i) => i !== index && cat.name.toLowerCase() === newName.toLowerCase()))
          return alert("Otra categoría ya tiene ese nombre.");
        categories[index].name = newName.trim();
        await saveCategoriesToGitHub();
        renderCategories();
        renderCategoryManagementList();
      }
    }

    async function deleteCategory(index) {
      if (confirm(`¿Eliminar "${categories[index].name}"?`)) {
        categories.splice(index, 1);
        await saveCategoriesToGitHub();
        renderCategories();
        renderCategoryManagementList();
      }
    }

    async function moveCategoryUp(index) {
      if (index > 0) {
        [categories[index - 1], categories[index]] = [categories[index], categories[index - 1]];
        await saveCategoriesToGitHub();
        renderCategories();
        renderCategoryManagementList();
      }
    }

    async function moveCategoryDown(index) {
      if (index < categories.length - 1) {
        [categories[index + 1], categories[index]] = [categories[index], categories[index + 1]];
        await saveCategoriesToGitHub();
        renderCategories();
        renderCategoryManagementList();
      }
    }

    // Inicializar el dashboard
    async function initialize() {
      await loadCategoriesFromGitHub();
      renderCategories();
    }

    initialize();
  </script>
</body>
</html>

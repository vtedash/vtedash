let categories = [];
let selectedCategoryName = null;

const GITHUB_TOKEN = "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"; // Mejor pedirlo por prompt o usar backend
const REPO_OWNER = "vtedash ";
const REPO_NAME = "vtedash ";
const FILE_PATH = "data.json";

async function loadCategoriesFromGitHub() {
  try {
    const response = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
      {
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`,
          Accept: "application/vnd.github.v3+json",
        },
      }
    );
    if (!response.ok) throw new Error("Error al cargar los datos desde GitHub");
    const fileData = await response.json();
    const content = atob(fileData.content);
    categories = JSON.parse(content);
  } catch (error) {
    console.error("Error al cargar categorÃ­as:", error);
    categories = [
      {
        id: 1,
        name: "Trabajo",
        color: "#3498db",
        bookmarks: [
          { title: "Gmail Corporativo", url: "https://mail.google.com", icon: "" },
        ],
      },
    ];
  }
}

async function saveCategoriesToGitHub() {
  try {
    const fileResponse = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
      {
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`,
          Accept: "application/vnd.github.v3+json",
        },
      }
    );
    if (!fileResponse.ok) throw new Error("Error al obtener el SHA del archivo");
    const fileData = await fileResponse.json();
    const sha = fileData.sha;

    const content = btoa(JSON.stringify(categories, null, 2));
    const commitMessage = "Actualizar data.json con nuevas categorÃ­as/marcadores";
    const updateResponse = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
      {
        method: "PUT",
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`,
          Accept: "application/vnd.github.v3+json",
        },
        body: JSON.stringify({
          message: commitMessage,
          content: content,
          sha: sha,
        }),
      }
    );
    if (!updateResponse.ok) throw new Error("Error al guardar los datos en GitHub");
  } catch (error) {
    console.error("Error al guardar categorÃ­as:", error);
    alert("No se pudo guardar los cambios en GitHub.");
  }
}

function renderCategories() {
  const grid = document.getElementById("bookmarksGrid");
  grid.innerHTML = "";
  categories.forEach((category) => {
    const categoryDiv = document.createElement("div");
    categoryDiv.className = "category";
    categoryDiv.setAttribute("data-category", category.name);

    const header = document.createElement("div");
    header.className = "category-header";
    header.style.backgroundColor = category.color;
    header.innerHTML = `${category.name}`;
    categoryDiv.appendChild(header);

    const bookmarkList = document.createElement("div");
    bookmarkList.className = "bookmark-list";
    category.bookmarks.forEach((bookmark) => {
      const a = document.createElement("a");
      a.href = bookmark.url;
      a.className = "bookmark";
      a.target = "_blank";
      let iconContent = bookmark.icon || '<span class="default-icon">ðŸ”—</span>';
      a.innerHTML = `${iconContent}${bookmark.title}`;
      bookmarkList.appendChild(a);
    });
    categoryDiv.appendChild(bookmarkList);
    grid.appendChild(categoryDiv);
  });
}

async function initialize() {
  await loadCategoriesFromGitHub();
  renderCategories();
}

initialize();

/**************************************
 * GestiÃ³n de CategorÃ­as y Marcadores *
 **************************************/

// Array global de categorÃ­as
let categories = [];
let selectedCategoryName = null;

// Variables para GitHub (reemplaza con tus datos)
const GITHUB_TOKEN = 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; // Reemplaza con tu token de acceso personal
const REPO_OWNER = vtedash; // Reemplaza con tu usuario de GitHub
const REPO_NAME = vtedash; // Reemplaza con el nombre de tu repositorio
const FILE_PATH = data.json; // Ruta del archivo en el repositorio

// Cargar categorÃ­as desde GitHub
async function loadCategoriesFromGitHub() {
  try {
    const response = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
      {
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`,
          Accept: "application/vnd.github.v3+json",
        },
      }
    );
    if (!response.ok) throw new Error("Error al cargar los datos desde GitHub");
    const fileData = await response.json();
    const content = atob(fileData.content); // Decodificar base64
    categories = JSON.parse(content);
  } catch (error) {
    console.error("Error al cargar categorÃ­as:", error);
    categories = [
      {
        id: 1,
        name: "Trabajo",
        color: "#3498db",
        bookmarks: [
          { title: "Gmail Corporativo", url: "https://mail.google.com", icon: "" },
        ],
      },
    ];
  }
}

// Guardar categorÃ­as en GitHub
async function saveCategoriesToGitHub() {
  try {
    const fileResponse = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
      {
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`,
          Accept: "application/vnd.github.v3+json",
        },
      }
    );
    if (!fileResponse.ok) throw new Error("Error al obtener el SHA del archivo");
    const fileData = await fileResponse.json();
    const sha = fileData.sha;

    const content = btoa(JSON.stringify(categories, null, 2)); // Codificar en base64
    const commitMessage = "Actualizar data.json con nuevas categorÃ­as/marcadores";

    const updateResponse = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
      {
        method: "PUT",
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`,
          Accept: "application/vnd.github.v3+json",
        },
        body: JSON.stringify({
          message: commitMessage,
          content: content,
          sha: sha,
        }),
      }
    );
    if (!updateResponse.ok) throw new Error("Error al guardar los datos en GitHub");
  } catch (error) {
    console.error("Error al guardar categorÃ­as:", error);
    alert("No se pudo guardar los cambios en GitHub. Revisa la consola.");
  }
}

// Renderizar categorÃ­as en el dashboard
function renderCategories() {
  const grid = document.getElementById("bookmarksGrid");
  grid.innerHTML = "";
  categories.forEach((category) => {
    const categoryDiv = document.createElement("div");
    categoryDiv.className = "category";
    categoryDiv.setAttribute("data-category", category.name);

    const header = document.createElement("div");
    header.className = "category-header";
    header.style.backgroundColor = category.color;
    header.innerHTML = `${category.name} <button onclick="openNewBookmarkModal('${category.name}')">+</button>`;
    categoryDiv.appendChild(header);

    const bookmarkList = document.createElement("div");
    bookmarkList.className = "bookmark-list";
    category.bookmarks.forEach((bookmark) => {
      const a = document.createElement("a");
      a.href = bookmark.url;
      a.className = "bookmark";
      a.target = "_blank";
      a.innerHTML = `${bookmark.icon || "ðŸ”—"} ${bookmark.title}`;
      bookmarkList.appendChild(a);
    });

    categoryDiv.appendChild(bookmarkList);
    grid.appendChild(categoryDiv);
  });
}

// Renderizar lista de categorÃ­as en el modal de gestiÃ³n
function renderCategoryManagementList() {
  const list = document.getElementById("categoriesList");
  list.innerHTML = "";
  categories.forEach((category, index) => {
    const item = document.createElement("div");
    item.className = "category-item";
    item.innerHTML = `
      ${category.name}
      <div class="category-actions">
        <button onclick="editCategory(${index})">Editar</button>
        <button onclick="deleteCategory(${index})">Eliminar</button>
        <button onclick="moveCategoryUp(${index})">â†‘</button>
        <button onclick="moveCategoryDown(${index})">â†“</button>
      </div>
    `;
    list.appendChild(item);
  });
}

// Abrir y cerrar modales
function openCategoryManagerModal() {
  renderCategoryManagementList();
  document.getElementById("categoryManagerModal").style.display = "block";
}

function closeCategoryManagerModal() {
  document.getElementById("categoryManagerModal").style.display = "none";
}

function openNewBookmarkModal(categoryName) {
  selectedCategoryName = categoryName;
  document.getElementById("newBookmarkForm").reset();
  document.getElementById("newBookmarkModal").style.display = "block";
}

function closeNewBookmarkModal() {
  document.getElementById("newBookmarkModal").style.display = "none";
}

window.onclick = function (event) {
  const categoryModal = document.getElementById("categoryManagerModal");
  const bookmarkModal = document.getElementById("newBookmarkModal");
  if (event.target === categoryModal) closeCategoryManagerModal();
  if (event.target === bookmarkModal) closeNewBookmarkModal();
};

// AÃ±adir nueva categorÃ­a
document.getElementById("newCategoryForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = document.getElementById("newCategoryName").value.trim();
  const color = document.getElementById("newCategoryColor").value;
  if (!name) return alert("Introduce un nombre para la categorÃ­a.");
  if (categories.some((cat) => cat.name.toLowerCase() === name.toLowerCase()))
    return alert("La categorÃ­a ya existe.");

  categories.push({ id: Date.now(), name, color, bookmarks: [] });
  await saveCategoriesToGitHub();
  renderCategories();
  renderCategoryManagementList();
  e.target.reset();
});

// AÃ±adir nuevo marcador
document.getElementById("newBookmarkForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!selectedCategoryName) return;
  const title = document.getElementById("bookmarkTitle").value.trim();
  const url = document.getElementById("bookmarkURL").value.trim();
  const icon = document.getElementById("bookmarkIcon").value.trim();
  if (!title || !url) return alert("Completa el tÃ­tulo y la URL.");

  const categoryIndex = categories.findIndex((cat) => cat.name === selectedCategoryName);
  if (categoryIndex === -1) return alert("CategorÃ­a no encontrada.");
  categories[categoryIndex].bookmarks.push({ title, url, icon });
  await saveCategoriesToGitHub();
  renderCategories();
  closeNewBookmarkModal();
});

// Funciones de ediciÃ³n y reordenamiento
async function editCategory(index) {
  const newName = prompt("Editar nombre:", categories[index].name);
  if (newName && newName.trim()) {
    if (categories.some((cat, i) => i !== index && cat.name.toLowerCase() === newName.toLowerCase()))
      return alert("Otra categorÃ­a ya tiene ese nombre.");
    categories[index].name = newName.trim();
    await saveCategoriesToGitHub();
    renderCategories();
    renderCategoryManagementList();
  }
}

async function deleteCategory(index) {
  if (confirm(`Â¿Eliminar "${categories[index].name}"?`)) {
    categories.splice(index, 1);
    await saveCategoriesToGitHub();
    renderCategories();
    renderCategoryManagementList();
  }
}

async function moveCategoryUp(index) {
  if (index > 0) {
    [categories[index - 1], categories[index]] = [categories[index], categories[index - 1]];
    await saveCategoriesToGitHub();
    renderCategories();
    renderCategoryManagementList();
  }
}

async function moveCategoryDown(index) {
  if (index < categories.length - 1) {
    [categories[index + 1], categories[index]] = [categories[index], categories[index + 1]];
    await saveCategoriesToGitHub();
    renderCategories();
    renderCategoryManagementList();
  }
}

// Inicializar el dashboard
async function initialize() {
  await loadCategoriesFromGitHub();
  renderCategories();
}

initialize();
